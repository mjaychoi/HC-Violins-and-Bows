echo "ğŸ” Running pre-commit checks..."

# Run lint-staged (formatting and linting)
echo "ğŸ“ Running lint-staged (formatting & linting)..."
npx lint-staged || {
  echo "âŒ lint-staged failed"
  exit 1
}

# Run type-check
echo "ğŸ” Running TypeScript type-check..."
npm run type-check || {
  echo "âŒ TypeScript type-check failed"
  exit 1
}

# Run lint check
echo "ğŸ” Running ESLint..."
npm run lint || {
  echo "âŒ ESLint failed"
  exit 1
}

# Run Prettier check (only on staged files for speed)
echo "ğŸ’… Running Prettier check on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md|css)$' || true)
if [ -n "$STAGED_FILES" ]; then
  npx prettier --check $STAGED_FILES || {
    echo "âŒ Prettier check failed. Run 'npx prettier --write .' to fix."
    exit 1
  }
else
  echo "â„¹ï¸  No files to check with Prettier"
fi

# Run tests (only on changed files for speed)
echo "ğŸ§ª Running tests on changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$CHANGED_FILES" ]; then
  # Run tests only for changed files using --findRelatedTests (faster)
  # This runs tests for files that import or are imported by changed files
  npm run test -- --findRelatedTests $CHANGED_FILES --passWithNoTests --bail || {
    echo "âŒ Tests failed"
    echo "ğŸ’¡ Tip: Run 'npm run test' to see all test failures"
    exit 1
  }
else
  echo "â„¹ï¸  No source files changed, skipping tests"
fi

echo "âœ… All pre-commit checks passed!"